<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tree-sitter R Playground</title>

  <!-- External dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/r/r.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clusterize.js/0.18.0/clusterize.min.js"></script>

  <!-- Load tree-sitter.js from unpkg CDN -->
  <script src="https://unpkg.com/web-tree-sitter@0.20.8"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/idea.min.css">
  <link rel="stylesheet" href="assets/playground.css">
</head>
<body>
  <div class="playground">
    <div class="playground-header">
      Tree-sitter R Grammar Playground
    </div>

    <div class="playground-body">
      <!-- Code editor section -->
      <div class="playground-section code-section">
        <div class="playground-section-header">R Code</div>
        <div id="code-container" class="playground-section-content"></div>
      </div>

      <!-- Syntax tree section -->
      <div class="playground-section tree-section">
        <div class="playground-section-header">Syntax Tree</div>
        <div id="tree-container" class="playground-section-content"></div>
      </div>
    </div>

    <!-- Query section -->
    <div class="playground-section query-section">
      <div class="playground-section-header">Query</div>
      <div id="query-container" class="playground-section-content"></div>
    </div>
  </div>

  <script>
    // DOM elements we'll use
    let codeEditor, tree, codeContainer, treeContainer, queryContainer, queryEditor;
    // Libraries we depend on
    // The tree-sitter objects we'll use
    let parser, rLanguage;

    // Wait for page to load then initialize the playground
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Get the DOM elements
        codeContainer = document.getElementById('code-container');
        treeContainer = document.getElementById('tree-container');
        queryContainer = document.getElementById('query-container');

        // Initialize tree-sitter library with explicit path to web-tree-sitter WASM
        await TreeSitter.init({
          locateFile() {
            return 'https://unpkg.com/web-tree-sitter@0.20.8/tree-sitter.wasm';
          }
        });

        // Create parser
        parser = new TreeSitter();

        // Load the R language WASM file
        console.log('Web-tree-sitter initialized, loading R grammar...');

        // Try different possible paths to find the WASM file
        let rLanguage;
        try {
          rLanguage = await TreeSitter.Language.load('assets/tree-sitter-r.wasm');
          console.log('Loaded R grammar from assets/tree-sitter-r.wasm');
        } catch (e1) {
          try {
            rLanguage = await TreeSitter.Language.load('playground/assets/tree-sitter-r.wasm');
            console.log('Loaded R grammar from playground/assets/tree-sitter-r.wasm');
          } catch (e2) {
            console.error('Failed to load grammar from standard paths, trying absolute path');
            rLanguage = await TreeSitter.Language.load('/playground/assets/tree-sitter-r.wasm');
          }
        }

        // Set language for parser
        parser.setLanguage(rLanguage);

        // Create code editor
        codeEditor = CodeMirror(codeContainer, {
          mode: 'r',
          lineNumbers: true,
          showCursorWhenSelecting: true,
          tabSize: 2,
          theme: 'default',
          value: 'foo <- function(\n  bar = 1,\n  baz = 2\n) {\n  list(bar, baz)\n}'
        });

        // Create query editor
        queryEditor = CodeMirror(queryContainer, {
          mode: 'text',
          lineNumbers: false,
          tabSize: 2,
          theme: 'default',
          placeholder: 'Enter a tree-sitter query...'
        });

        // Set up event handlers
        codeEditor.on('changes', debounce(parseCode, 250));
        queryEditor.on('changes', debounce(runQuery, 250));

        // Initial parse
        parseCode();
      } catch (error) {
        console.error('Error initializing playground:', error);
        displayError('Failed to initialize playground: ' + error.message);
      }
    });

    // Parse current code and update the tree
    function parseCode() {
      try {
        const code = codeEditor.getValue();

        // Parse the code
        tree = parser.parse(code);

        // Render the tree
        renderTree(tree.rootNode);
      } catch (error) {
        console.error('Error parsing code:', error);
        displayError('Error parsing code: ' + error.message);
      }
    }

    // Run a query on the current code
    function runQuery() {
      if (!tree) return;

      try {
        const queryString = queryEditor.getValue().trim();

        if (!queryString) {
          parseCode(); // Re-render without query highlighting
          return;
        }

        const language = parser.getLanguage();
        const query = language.query(queryString);
        const matches = query.matches(tree.rootNode);

        // Highlight matching nodes in the code
        highlightMatches(matches);

        // Render tree with highlighting
        renderTree(tree.rootNode, matches);
      } catch (error) {
        console.error('Error running query:', error);
        displayError('Error in query: ' + error.message);
      }
    }

    function highlightMatches(matches) {
      // Clear previous highlights
      codeEditor.getAllMarks().forEach(m => m.clear());

      // Add new highlights
      matches.forEach(match => {
        match.captures.forEach(capture => {
          const { node } = capture;
          const start = { line: node.startPosition.row, ch: node.startPosition.column };
          const end = { line: node.endPosition.row, ch: node.endPosition.column };

          codeEditor.markText(start, end, {
            className: `capture-${capture.name || 'node'}`
          });
        });
      });
    }

    // Render the syntax tree
    function renderTree(rootNode, matches = []) {
      if (!treeContainer) return;

      treeContainer.innerHTML = '';

      const cursor = tree.walk();

      // Create a document fragment for better performance
      const fragment = document.createDocumentFragment();

      function renderNode(depth = 0) {
        // Check if this node is highlighted by a query match
        const isHighlighted = matches.some(match =>
          match.captures.some(capture => capture.node.id === cursor.currentNode.id)
        );

        const displayName = cursor.nodeIsNamed ? cursor.nodeType : `"${cursor.nodeType}"`;
        const start = cursor.startPosition;
        const end = cursor.endPosition;

        const row = document.createElement('div');
        row.className = isHighlighted ? 'tree-row highlighted' : 'tree-row';
        row.style.marginLeft = (depth * 12) + 'px';

        const nodeType = document.createElement('span');
        nodeType.className = cursor.nodeIsNamed ? 'node-type' : 'anonymous-node-type';
        nodeType.textContent = displayName;
        row.appendChild(nodeType);

        const position = document.createElement('span');
        position.className = 'tree-node-position';
        position.textContent = ` [${start.row},${start.column} - ${end.row},${end.column}]`;
        row.appendChild(position);

        // Add event listener to highlight the corresponding code when clicked
        row.addEventListener('click', () => {
          codeEditor.focus();
          codeEditor.setSelection(
            { line: start.row, ch: start.column },
            { line: end.row, ch: end.column }
          );
        });

        fragment.appendChild(row);

        if (cursor.gotoFirstChild()) {
          do {
            renderNode(depth + 1);
          } while (cursor.gotoNextSibling());
          cursor.gotoParent();
        }
      }

      renderNode();
      treeContainer.appendChild(fragment);
    }

    // Helper function to display errors
    function displayError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;

      treeContainer.innerHTML = '';
      treeContainer.appendChild(errorDiv);
    }

    // Debounce function to limit how often a function is called
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }
  </script>
</body>
</html>
